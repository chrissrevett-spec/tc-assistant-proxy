<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talking Care Navigator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; scrollbar-color: #ccc #FAFAFA; scrollbar-width: thin; }
    html::-webkit-scrollbar, body::-webkit-scrollbar { width: 10px; }
    html::-webkit-scrollbar-track, body::-webkit-scrollbar-track { background: #FAFAFA; }
    html::-webkit-scrollbar-thumb, body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 8px; }
    html:hover::-webkit-scrollbar-thumb, body:hover::-webkit-scrollbar-thumb { background: #b3b3b3; }

    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #fff; color: #000; }

    /* Shell */
    .shell { width: 100%; max-width: 980px; margin: 0 auto; min-height: 100dvh; display: flex; flex-direction: column; }
    .wrap { flex: 1; padding: 16px; display: flex; flex-direction: column; gap: 12px; }

    /* Header */
    h1 { margin: 0; font-size: 22px; }
    .sub { margin: 0; font-size: 14px; color: #000; opacity: .9; }
    #status { font-size: 12px; color: #555; min-height: 18px; }

    /* Chat area */
    .chat {
      flex: 0 0 auto;
      border: 1px solid #eee; background: #fff; border-radius: 12px;
      padding: 12px; overflow-y: auto; max-height: none;
      box-shadow: 0 0 0 1px rgba(0,0,0,.03), 0 12px 24px rgba(0,0,0,.06);
    }

    /* Message bubbles */
    .msg { display: flex; gap: 10px; margin: 10px 0; align-items: flex-start; }
    .msg.assistant { flex-direction: row; }
    .msg.user { flex-direction: row-reverse; }

    .avatar {
      flex: 0 0 32px; height: 32px; width: 32px; border-radius: 50%;
      display: grid; place-items: center; background: #FAFAFA; border: 1px solid #eee;
      font-size: 18px; line-height: 1;
    }

    .bubble {
      max-width: 80%;
      background: #FAFAFA; color: #000;
      border: 1px solid #eee; border-radius: 14px;
      padding: 10px 12px; position: relative;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      overflow: hidden;
    }

    .msg.user .bubble {
      background: #FFF; border-color: #ddd;
    }

    /* Bubble header (title row) */
    .bubble-head {
      display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
      font-weight: 600; font-size: 13px; color: #111;
    }

    /* Copy button */
    .bubble-actions {
      margin-left: auto; display: flex; gap: 6px;
    }
    .copy-btn {
      border: 1px solid #ddd; background: #FAFAFA; color: #333; border-radius: 6px;
      font-size: 12px; padding: 2px 6px; cursor: pointer;
    }
    .copy-btn:hover { background: #f0f0f0; }

    /* Bubble content */
    .bubble-content { font-size: 14px; line-height: 1.5; }
    .bubble-content p { margin: 0 0 8px; }
    .bubble-content code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f5f5f5; padding: 1px 4px; border-radius: 4px; border: 1px solid #eee; }
    .bubble-content pre { background: #f5f5f5; padding: 8px; border-radius: 8px; overflow-x: auto; border: 1px solid #eee; }
    .bubble-content h1, .bubble-content h2, .bubble-content h3 { margin: 12px 0 6px; }
    .bubble-content ul, .bubble-content ol { margin: 8px 0 8px 20px; }
    .bubble-content blockquote { margin: 8px 0; padding: 8px 12px; background: #f7f7f7; border-left: 3px solid #ddd; border-radius: 6px; }

    /* Table styling for Markdown */
    .bubble-content table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 14px; }
    .bubble-content th, .bubble-content td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; vertical-align: top; }
    .bubble-content th { background: #f7f7f7; }
    .bubble-content tr:nth-child(even) td { background: #fcfcfc; }

    /* Sources footer */
    .sources {
      margin-top: 10px; padding-top: 8px; border-top: 1px dashed #e5e5e5; font-size: 13px; color: #444;
    }
    .sources .title { font-weight: 600; margin-bottom: 6px; }

    /* Input bar */
    .inputbar {
      position: relative;
      background: #fff; padding: 10px 0 0; margin-top: 6px;
      border-top: 1px solid #f0f0f0;
    }
    .inputrow { display: flex; gap: 8px; }
    textarea {
      flex: 1; min-height: 48px; max-height: 160px; resize: vertical;
      padding: 10px; font: inherit; background: #FAFAFA; color: #000;
      border: 1px solid #ddd; border-radius: 10px; transition: background .2s, border-color .2s, box-shadow .2s;
      scrollbar-width: thin; scrollbar-color: #ccc #FAFAFA; box-sizing: border-box;
    }
    textarea:focus { background: #f7f7f7; border-color: #ccc; outline: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.04); }

    button {
      padding: 10px 14px; cursor: pointer; border-radius: 10px; border: 1px solid #ddd;
      background: #FAFAFA; color: #333; transition: background .2s, color .2s, border-color .2s, box-shadow .2s;
    }
    button:hover { background: #f0f0f0; border-color: #ccc; }
    button.secondary { background: #FAFAFA; color: #333; border-color: #ddd; }

    /* Helper */
    .sr { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="wrap">
      <div>
        <h1>Talking Care Navigator</h1>
        <p class="sub">Ask me anything about adult social care in England, including CQC registrations, regulations and guidance, Mental Capacity Act and DoLS queries, best practice advice, case management and more.</p>
        <div id="status"></div>
      </div>

      <div id="chat" class="chat" aria-live="polite" aria-busy="false"></div>

      <div class="inputbar">
        <div class="inputrow">
          <label for="tc-input" class="sr">Message</label>
          <textarea id="tc-input" placeholder="Type your question‚Ä¶ üôÇ"></textarea>
          <button id="tc-ask-stream" title="Send">‚úàÔ∏è Send</button>
          <button id="tc-clear" class="secondary" title="Clear chat">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Force page load to start at top -->
  <script>
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }
    window.addEventListener('DOMContentLoaded', () => {
      window.scrollTo(0, 0);
      setTimeout(() => window.scrollTo(0, 0), 0);
    });
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) {
        window.scrollTo(0, 0);
      }
    });
  </script>

  <!-- Markdown parser (ESM) -->
  <script type="module">
    import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
    const purifyUrl = "https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js";
    await import(purifyUrl);

    // (rest of your module code unchanged‚Ä¶)
  </script>
</body>
</html>
