<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talking Care Navigator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="widget-ui.css" />
</head>
<body>
  <div class="shell" id="shell">
    <div class="wrap">
      <h1>Talking Care Navigator</h1>
      <p class="sub">Ask me anything about adult social care in England, including CQC registrations, regulations and guidance, Mental Capacity Act and DoLS queries, best practice advice, auditing, policy queries and more. Always consult your organisations' confidentiality policy.</p>
      <div id="status"></div>
    </div>

    <div class="inputbar" id="inputbar">
      <div class="inputrow">
        <label for="tc-input" class="sr">Message</label>
        <textarea id="tc-input" placeholder="Type your question… 🙂"></textarea>
        <button id="tc-ask-stream" title="Send">✈️ Send</button>
        <button id="tc-clear" class="secondary" title="Clear chat">Clear</button>
      </div>
      <div class="attach-row">
        <input id="file-input" type="file" style="display:none" />
        <button id="attach-btn" class="attach-btn" title="Attach a file">📌 Attach</button>
        <span id="attach-status" class="attach-status pending" style="display:none;">
          <span class="icon" id="attach-icon">⌛</span>
          <span class="fname" id="attach-name"></span>
        </span>
      </div>
    </div>

    <div class="chat-wrap" id="chatwrap">
      <div id="chat" class="chat" aria-live="polite" aria-busy="false"></div>
    </div>
  </div>

  <script type="module">
    const API_BASE = location.origin.replace(/\/$/, "");
    const $fileInput    = document.getElementById("file-input");
    const $attachBtn    = document.getElementById("attach-btn");
    const $attachStatus = document.getElementById("attach-status");
    const $attachIcon   = document.getElementById("attach-icon");
    const $attachName   = document.getElementById("attach-name");

    let pendingUpload = { file_id: null, filename: "" };

    $attachBtn.addEventListener("click", () => $fileInput.click());

    $fileInput.addEventListener("change", async () => {
      const file = $fileInput.files?.[0];
      if (!file) return;
      $attachStatus.style.display = "inline-flex";
      $attachStatus.className = "attach-status pending";
      $attachIcon.textContent = "⌛";
      $attachName.textContent = file.name.length > 36 ? file.name.slice(0, 33) + "..." : file.name;

      try {
        const fd = new FormData();
        fd.append("file", file);
        const r = await fetch(`${API_BASE}/api/upload`, { method: "POST", body: fd });
        if (!r.ok) throw new Error(await r.text());

        const data = await r.json();
        if (!data.ok || !data.file?.id) throw new Error("Upload failed");

        pendingUpload = { file_id: data.file.id, filename: file.name };
        $attachStatus.className = "attach-status ok";
        $attachIcon.textContent = "✅";
        $attachName.textContent = file.name.length > 36 ? file.name.slice(0, 33) + "..." : file.name;
      } catch (e) {
        console.error("Upload error", e);
        $attachStatus.className = "attach-status error";
        $attachIcon.textContent = "⚠️";
        $attachName.textContent = "Upload failed";
        pendingUpload = { file_id: null, filename: "" };
      }
    });

    window.getPendingUpload = () => pendingUpload;
    window.clearPendingUpload = () => {
      pendingUpload = { file_id: null, filename: "" };
      $fileInput.value = "";
      $attachStatus.style.display = "none";
      $attachStatus.className = "attach-status pending";
      $attachIcon.textContent = "⌛";
      $attachName.textContent = "";
    };
  </script>
</body>
</html>
