<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talking Care Navigator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; scrollbar-color: #ccc #FAFAFA; scrollbar-width: thin; }
    html::-webkit-scrollbar, body::-webkit-scrollbar { width: 10px; }
    html::-webkit-scrollbar-track, body::-webkit-scrollbar-track { background: #FAFAFA; }
    html::-webkit-scrollbar-thumb, body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 8px; }
    html:hover::-webkit-scrollbar-thumb, body:hover::-webkit-scrollbar-thumb { background: #b3b3b3; }

    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0; padding: 0; background: #fff; color: #000;
      display: flex; flex-direction: column; min-height: 100dvh;
    }

    .shell { width: 100%; max-width: 980px; margin: 0 auto; flex: 1 1 auto; display: flex; flex-direction: column; }

    .wrap { padding: 16px 16px 8px; }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .sub { margin: 0; font-size: 14px; color: #000; opacity: .9; }
    #status { font-size: 12px; color: #555; min-height: 18px; margin-top: 6px; }

    .inputbar {
      background: #fff;
      padding: 8px 16px 12px;
      border-top: 1px solid #f0f0f0;
      border-bottom: 1px solid #f0f0f0;
      order: 2;
      position: sticky; bottom: 0; z-index: 2;
    }

    .inputrow { display: flex; gap: 8px; align-items: flex-start; flex-wrap: nowrap; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    .sr { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }

    textarea {
      flex: 1 1 auto; min-height: 48px; max-height: 160px; resize: vertical;
      padding: 10px; font: inherit; background: #FAFAFA; color: #000;
      border: 1px solid #ddd; border-radius: 10px; transition: background .2s, border-color .2s, box-shadow .2s;
      scrollbar-width: thin; scrollbar-color: #ccc #FAFAFA; box-sizing: border-box;
    }
    textarea:focus { background: #f7f7f7; border-color: #ccc; outline: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.04); }

    .ui-btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      height: 40px; padding: 0 14px; cursor: pointer; border-radius: 10px; border: 1px solid #ddd;
      background: #FAFAFA; color: #333; font-size: 14px; line-height: 1; letter-spacing: .2px;
      transition: background .2s, color .2s, border-color .2s, box-shadow .2s, transform .08s ease;
      white-space: nowrap; user-select: none; flex: 0 0 auto;
    }
    .ui-btn:hover { background: #f0f0f0; border-color: #ccc; }
    .ui-btn.secondary { background: #FAFAFA; color: #333; border-color: #ddd; }
    .ui-btn.secondary:hover { background: #f0f0f0; border-color: #bbb; }
    .ui-btn.danger { border-color: #f2b8b8; color: #b40000; }
    .ui-btn:disabled { opacity: .5; cursor: not-allowed; }

    .ui-btn .emoji { font-size: 18px; line-height: 1; display: inline-block; }

    @keyframes hop {
      0%   { transform: translateY(0); }
      50%  { transform: translateY(-3px); }
      100% { transform: translateY(0); }
    }
    @keyframes spinOnce {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    /* Hover hop animations */
    #attach-btn:hover .clip-emoji,
    #tc-clear:hover .trash-emoji,
    #tc-ask-stream:hover .send-emoji { animation: hop 600ms ease-in-out infinite; }

    /* Spin once on click */
    .spin-once { animation: spinOnce 500ms ease-in-out 1; }

    @media (max-width: 540px) {
      .inputrow { flex-wrap: wrap; }
      .inputrow textarea { flex: 1 1 100%; width: 100%; }
      .controls { gap: 6px; }
      .ui-btn { height: 38px; }
    }

    .attach-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; flex-wrap: wrap; }
    .attach-status {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #ddd; background: #FAFAFA;
      max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .attach-status .fname { max-width: 36ch; overflow: hidden; text-overflow: ellipsis; }
    .attach-status.ok { border-color: #4caf50; background: #f2fff2; color: #256f2a; }
    .attach-status.pending { border-color: #ddd; background: #FAFAFA; color: #333; }
    .attach-status.error { border-color: #e57373; background: #fff5f5; color: #b71c1c; }
    .attach-status .icon { font-size: 14px; }

    .drop-active textarea { border-color: #9ad0ff; box-shadow: 0 0 0 3px rgba(0,140,255,0.12); background: #f5fbff; }

    .chat-wrap { display: none; flex: 1 1 auto; overflow-y: auto; }
    .chat {
      border: 1px solid #eee; background: #fff; border-radius: 12px;
      padding: 12px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.03), 0 12px 24px rgba(0,0,0,.06);
      margin: 12px 16px 0;
    }
    .chat-active .chat-wrap { display: block; order: 2; }
    .chat-active .inputbar { order: 3; border-top: none; }

    .msg { display: flex; gap: 10px; margin: 10px 0; align-items: flex-start; }
    .msg.assistant { flex-direction: row; }
    .msg.user { flex-direction: row-reverse; }

    .avatar {
      flex: 0 0 32px; height: 32px; width: 32px; border-radius: 50%;
      display: grid; place-items: center; background: #FAFAFA; border: 1px solid #eee;
      font-size: 18px; line-height: 1; overflow: hidden;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

    .bubble { max-width: 80%; background: #FAFAFA; color: #000; border: 1px solid #eee; border-radius: 14px;
      padding: 10px 12px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,.04); overflow: hidden; }
    .msg.user .bubble { background: #FFF; border-color: #ddd; }

    .bubble-head { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #111; }
    .bubble-meta { margin-left: auto; font-weight: 400; font-size: 11px; color: #777; }

    .bubble-actions { margin-left: 8px; display: flex; gap: 6px; }
    .copy-btn { border: 1px solid #ddd; background: #FAFAFA; color: #333; border-radius: 6px;
      font-size: 12px; padding: 2px 6px; cursor: pointer; }
    .copy-btn:hover { background: #f0f0f0; }

    .used-file-note, .upload-banner, .error-banner {
      display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 4px 8px;
      border-radius: 999px; border: 1px solid #ddd; background: #FAFAFA; margin-top: 6px;
    }
    .used-file-note { border-color: #4caf50; background: #f2fff2; color: #256f2a; }
    .upload-banner { border-color: #4caf50; background: #f2fff2; color: #256f2a; }
    .error-banner { border-color: #e57373; background: #fff5f5; color: #b71c1c; }

    .using-chip { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 4px 8px;
      border-radius: 999px; border: 1px solid #cde6cd; background: #f6fff6; color: #215c21;
      margin: 0 0 8px; max-width: 100%; }
    .using-chip .fname { max-width: 40ch; overflow: hidden; text-overflow: ellipsis; }

    .bubble-content { font-size: 14px; line-height: 1.5; }
    .bubble-content p { margin: 0 0 8px; }
    .bubble-content code { font-family: ui-monospace, monospace; background: #f5f5f5; padding: 1px 4px; border-radius: 4px; border: 1px solid #eee; }
    .bubble-content pre { background: #f5f5f5; padding: 8px; border-radius: 8px; overflow-x: auto; border: 1px solid #eee; }
    .bubble-content ul, .bubble-content ol { margin: 8px 0 8px 20px; }
    .bubble-content blockquote { margin: 8px 0; padding: 8px 12px; background: #f7f7f7; border-left: 3px solid #ddd; border-radius: 6px; }

    .sources { margin-top: 10px; padding-top: 8px; border-top: 1px dashed #e5e5e5; font-size: 13px; color: #444; }
    .sources .title { font-weight: 600; margin-bottom: 6px; }
    .sources a { color: inherit; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="shell" id="shell">
    <div class="wrap">
      <h1>Talking Care Navigator</h1>
      <p class="sub">Ask me anything about adult social care in England‚Ä¶</p>
      <div id="status" role="status" aria-live="polite"></div>
    </div>

    <div class="inputbar" id="inputbar">
      <div class="inputrow" id="dropzone">
        <label for="tc-input" class="sr">Message</label>
        <textarea id="tc-input" placeholder="Type your question‚Ä¶ üôÇ" aria-label="Message"></textarea>
        <div class="controls">
          <button id="tc-ask-stream" class="ui-btn" title="Send">
            <span class="emoji send-emoji">‚úàÔ∏è</span> Send
          </button>
          <button id="tc-stop" class="ui-btn danger" title="Stop response" disabled>
            <span class="emoji">‚èπ</span> Stop
          </button>
          <button id="tc-clear" class="ui-btn secondary" title="Clear chat">
            <span class="emoji trash-emoji">üóëÔ∏è</span> Clear
          </button>
          <button id="attach-btn" class="ui-btn" title="Attach a file">
            <span class="emoji clip-emoji">üìé</span> Attach
          </button>
        </div>
      </div>
      <div class="attach-row">
        <input id="file-input" type="file" style="display:none" />
        <span id="attach-status" class="attach-status pending" style="display:none;">
          <span class="icon" id="attach-icon">‚åõ</span>
          <span class="fname" id="attach-name"></span>
        </span>
      </div>
    </div>

    <div class="chat-wrap" id="chatwrap">
      <div id="chat" class="chat" aria-live="polite"></div>
    </div>
  </div>

  <script type="module">
    // ... all your existing JS ...
    // Auto-scroll fix: scroll chat not inputbar
    function scrollToBottom() {
      $chat.scrollIntoView({ block: "end", behavior: "smooth" });
    }

    // Replace all $inputbar.scrollIntoView calls with scrollToBottom()
    // In createMsg, renderMarkdown, appendSources, streaming handlers

    // File upload catch: show friendlier error
    async function handleFiles(fileList) {
      const file = fileList?.[0]; if (!file) return;
      if (file.size > MAX_UPLOAD_BYTES) { /* existing code */ return; }
      $attachStatus.style.display="inline-flex"; // ‚Ä¶
      try {
        const fd=new FormData(); fd.append("file",file);
        const r=await fetch(`${API_BASE}/api/upload`,{method:"POST",body:fd});
        const data=await r.json().catch(()=>({}));
        if(!r.ok||!data.ok||!data.file_id){
          if(data?.error?.includes("File type not supported")){
            throw new Error("File type not supported. Please upload a different file.");
          }
          throw new Error(data?.error||"Upload failed");
        }
        // success ‚Ä¶
      } catch(e){
        $attachStatus.className="attach-status error";
        $attachIcon.textContent="‚ö†Ô∏è";
        $attachName.textContent=e?.message||"Upload failed";
        pendingUpload={file_id:null,filename:""};
      }
    }

    // Spin animation triggers for send and clear
    [$send, $clear].forEach(btn=>{
      btn.addEventListener("click",()=>{
        const icon=btn.querySelector(".emoji");
        if(icon){ icon.classList.remove("spin-once"); void icon.offsetWidth; icon.classList.add("spin-once"); }
      });
    });
  </script>
</body>
</html>
